---
title: "Readme"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      results = "hold")
```



## Case 1


Let's say I have a very complex function `f`. In order to have a cleaner and more understandable code, I have created another function `f1` that is called by this main function. These two function are defined in a `.R` file named `functionDefinition.R`:

```{r echo=FALSE, results='asis'}
cat('```r\n')
cat(paste(readLines('functionsDefinition.R'), "\n"))
cat('```')
```


Now I want to save in a `.rds` file the function and another parameter for later used. So I (naively) do:

```{r}
createSetup <- function(funDefFile, y) {
  source(funDefFile)
  z <- paste(y, y) # some complex stuff
  list(param = z,
       fun = f)
}

mySetup <- createSetup('functionsDefinition.R', "toto")
saveRDS(mySetup, 'savedSetup-1.rds')
```


Then later in **a new R-session** I load my "setup" and call my function:

```r
mySetup <- readRDS("savedSetup-1.rds")
mySetup$fun(10)
```

**Question: What will happen?**


<details><summary>Click to see the anwser</summary>

```{sh}
R -q --vanilla -e '
tryCatch({
mySetup <- readRDS("savedSetup-1.rds")
mySetup$fun(10)
}, error = function(err) {
  message(err)
})
'
```

**It raise an error.**

Indeed by doing this way, I saved in the `mySetup` list the definition of `f` but not `f1` so when I load it back `f1` is not defined.

Note: by default the function `source` evaluate the given file in the global environment.

</details>




## Case 2:

If I specify that the function `source` should evaluate the function definition in the local environment, it should not change anything, I still do not save (explicitly) `f1`:

```{r}
createSetup_2 <- function(funDefFile, y) {
  source(funDefFile, environment())
  z <- paste(y, y) # some complex stuff
  list(param = z,
       fun = f)
}
```

```{r}
mySetup <- createSetup_2('functionsDefinition.R', "toto")
saveRDS(mySetup, 'savedSetup-2.rds')
```

Again I load my new setup:

```r
mySetup <- readRDS("savedSetup-2.rds")
mySetup$fun(10)
```

**Question: What will happen?**


<details><summary>Click to see the anwser</summary>

```{sh}
R -q --vanilla -e '
tryCatch({
mySetup <- readRDS("savedSetup-2.rds")
mySetup$fun(10)
}, error = function(err) {
  message(err)
})
'
```

**It works !**

But I don't understand why...

</details>


## Case 3


Now let's get rid of the `source` function:

```{r}
createSetup_3 <- function(funDefFile, y) {
  
  f1 <- function(x) { 
    x^2 
  } 
  
  f <- function(x) { 
    f1(x) + 1 
  } 
  
  z <- paste(y, y) # some complex stuff
  list(param = z,
       fun = f)
}
```

```{r}
mySetup <- createSetup_3('functionsDefinition.R', "toto")
saveRDS(mySetup, 'savedSetup-3.rds')
```

Again I load my new setup:

```r
mySetup <- readRDS("savedSetup-3.rds")
mySetup$fun(10)
```

**Question: What will happen?**


<details><summary>Click to see the anwser</summary>

```{sh}
R -q --vanilla -e '
tryCatch({
mySetup <- readRDS("savedSetup-2.rds")
mySetup$fun(10)
}, error = function(err) {
  message(err)
})
'
```

It also work, but this would be expected because it should behave like case 2.

</details>



## Case 4


Now let's source in a new environment:

```{r}
createSetup_4 <- function(funDefFile, y) {
  env <- new.env()
  source(funDefFile, env)
  
  z <- paste(y, y) # some complex stuff
  list(param = z,
       fun = env$f)
}
```

```{r}
mySetup <- createSetup_4('functionsDefinition.R', "toto")
saveRDS(mySetup, 'savedSetup-4.rds')
```

Again I load my new setup:

```r
mySetup <- readRDS("savedSetup-4.rds")
mySetup$fun(10)
```

**Question: What will happen?**


<details><summary>Click to see the anwser</summary>

```{sh}
R -q --vanilla -e '
tryCatch({
mySetup <- readRDS("savedSetup-4.rds")
mySetup$fun(10)
}, error = function(err) {
  message(err)
})
'
```

It also work, but this would be expected because it should behave like case 2.

</details>


## Other information


Let's have a look on the objects'/setup files' size and hash:

```{r}
setup1 <- createSetup('functionsDefinition.R', "toto")
setup2 <- createSetup_2('functionsDefinition.R', "toto")
setup3 <- createSetup_3('functionsDefinition.R', "toto")
setup4 <- createSetup_4('functionsDefinition.R', "toto")

setup1_2 <- readRDS('savedSetup-1.rds')
setup2_2 <- readRDS('savedSetup-2.rds')
setup3_2 <- readRDS('savedSetup-3.rds')
setup4_2 <- readRDS('savedSetup-4.rds')

object.size(setup1)
object.size(setup1_2)

object.size(setup2)
object.size(setup2_2)

object.size(setup3)
object.size(setup3_2)

object.size(setup4)
object.size(setup4_2)
```


```{r}
digest::digest(setup1)
digest::digest(setup1_2)
identical(setup1, setup1_2)
all.equal(setup1, setup1_2)

digest::digest(setup2)
digest::digest(setup2_2)
identical(setup2, setup2_2)
all.equal(setup2, setup2_2)


digest::digest(setup3)
digest::digest(setup3_2)
identical(setup3, setup3_2)
all.equal(setup3, setup3_2)

digest::digest(setup4)
digest::digest(setup4_2)
identical(setup4, setup4_2)
all.equal(setup4, setup4_2)
```



```{r}
tools::md5sum('savedSetup-1.rds')
tools::md5sum('savedSetup-2.rds')
tools::md5sum('savedSetup-3.rds')
tools::md5sum('savedSetup-4.rds')

file.info(c('savedSetup-1.rds',
            'savedSetup-2.rds',
            'savedSetup-3.rds',
            'savedSetup-2.rds'))$size
```



```{r}
str(setup1$fun)
str(setup2$fun)
str(setup3$fun)
str(setup4$fun)
```




```{r}
all.equal(setup2, setup3)
all.equal(setup2, setup4)
```

```{r}
all.equal(setup1, setup2)
```


## Any help would be much appreciated

If someone reading this understand what is happening on "Case 2" I would be very happy to know it. You can open [an issue in this repo.](https://github.com/juliendiot42/question-about-R/issues).

Thank you very much.


# session info:



<details>
<summary style="margin-bottom: 10px;">Session Information (click to expand)</summary>
<!-- Place an empty line before the chunk ! -->

```{r sessionInfo, echo=FALSE}
  options(max.print = 10000)
  if (Sys.info()["sysname"] == "Linux") {
    cat("\nCPU: ")
    cat(unique(system("awk -F': ' '/model name/{print $2}' /proc/cpuinfo", intern = T)))
    cat("\nMemory total size: ")
    cat(as.numeric(system("awk '/MemTotal/ {print $2}' /proc/meminfo", intern = T))*10^(-6), "GB")
  }
  cat("\n\n\nSession information:\n")
  print(sessionInfo(), locale = FALSE)
```

</details>
